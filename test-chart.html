<!DOCTYPE html>
<html>
<head>
    <title>Chart Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        #chartContainer { width: 800px; height: 400px; border: 1px solid #444; margin: 20px 0; }
        .debug { background: #333; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .debug pre { margin: 0; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Chart Debug Test</h1>
    <div id="chartContainer"></div>
    
    <div class="debug">
        <h3>Debug Information:</h3>
        <div id="debugInfo">Loading...</div>
    </div>

    <script type="module">
        const debugInfo = document.getElementById('debugInfo');
        
        function log(message) {
            console.log(message);
            debugInfo.innerHTML += '<pre>' + JSON.stringify(message, null, 2) + '</pre>';
        }
        
        log('Starting chart test...');
        
        // Test the API first
        const apiUrl = 'http://localhost:3001/api/backtest/chart?symbol=ATOMUSDT&tf=15m&start_date=2025-08-12T10:00:00.000Z&end_date=2025-08-12T16:00:00.000Z&limit=100';
        
        try {
            log('Fetching data from: ' + apiUrl);
            const response = await fetch(apiUrl);
            const data = await response.json();
            log('API Response: ' + data.candles?.length + ' candles received');
            
            if (data.candles && data.candles.length > 0) {
                log('Sample data point: ' + JSON.stringify(data.candles[0]));
                
                // Try to load lightweight-charts
                try {
                    log('Loading lightweight-charts...');
                    const { createChart, ColorType } = await import('https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js');
                    log('Lightweight-charts loaded successfully');
                    
                    const chartContainer = document.getElementById('chartContainer');
                    const chart = createChart(chartContainer, {
                        layout: {
                            background: { type: ColorType.Solid, color: 'transparent' },
                            textColor: '#d1d5db',
                            fontSize: 12,
                        },
                        width: 800,
                        height: 400,
                    });
                    
                    log('Chart created successfully');
                    
                    const candlestickSeries = chart.addCandlestickSeries({
                        upColor: '#10b981',
                        downColor: '#ef4444',
                        borderDownColor: '#ef4444',
                        borderUpColor: '#10b981',
                        wickDownColor: '#ef4444',
                        wickUpColor: '#10b981',
                    });
                    
                    log('Candlestick series added');
                    
                    const formattedData = data.candles.map(d => ({
                        time: d.time,
                        open: d.open,
                        high: d.high,
                        low: d.low,
                        close: d.close,
                    }));
                    
                    log('Data formatted, setting on chart...');
                    candlestickSeries.setData(formattedData);
                    
                    log('Data set, fitting content...');
                    setTimeout(() => {
                        chart.timeScale().fitContent();
                        log('Chart render complete!');
                    }, 100);
                    
                } catch (chartError) {
                    log('Chart error: ' + chartError.message);
                }
            } else {
                log('No chart data available');
            }
        } catch (apiError) {
            log('API error: ' + apiError.message);
        }
    </script>
</body>
</html>